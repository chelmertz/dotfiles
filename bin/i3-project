#!/usr/bin/env bash
set -euo pipefail

PROJECTS_FILE="$HOME/.config/i3/projects"
PREFERRED_SLOTS=(1 4 5 8 3 6)
SEP=" - "

# Ensure projects file exists
mkdir -p "$(dirname "$PROJECTS_FILE")"
touch "$PROJECTS_FILE"

# Read active projects into associative array: slot -> name
declare -A active_projects
while IFS=: read -r slot name; do
    [[ -n "$slot" && -n "$name" ]] && active_projects[$slot]="$name"
done < "$PROJECTS_FILE"

save_projects() {
    > "$PROJECTS_FILE"
    for slot in "${!active_projects[@]}"; do
        echo "${slot}:${active_projects[$slot]}" >> "$PROJECTS_FILE"
    done
    # Sort for consistency
    sort -t: -k1 -n -o "$PROJECTS_FILE" "$PROJECTS_FILE"
}

next_available_slot() {
    for slot in "${PREFERRED_SLOTS[@]}"; do
        if [[ -z "${active_projects[$slot]:-}" ]]; then
            echo "$slot"
            return
        fi
    done
    return 1
}

ws_name() {
    local slot="$1" name="$2"
    echo "${slot}${SEP}${name}"
}

current_workspace_num() {
    i3-msg -t get_workspaces | jq -r '.[] | select(.focused).name' | grep -oP '^\d+'
}

is_project_slot() {
    local num="$1"
    for slot in "${PREFERRED_SLOTS[@]}"; do
        [[ "$slot" == "$num" ]] && return 0
    done
    return 1
}

name_is_taken() {
    local name="$1"
    local exclude_slot="${2:-}"
    for slot in "${!active_projects[@]}"; do
        [[ "$slot" == "$exclude_slot" ]] && continue
        if [[ "${active_projects[$slot]}" == "$name" ]]; then
            return 0
        fi
    done
    return 1
}

create_project() {
    local name="$1" slot="$2"
    local current_ws_name
    current_ws_name=$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused).name')

    if [[ "$slot" == "$current_ws_name" ]] || [[ "$current_ws_name" =~ ^${slot}(${SEP}|$) ]]; then
        # We're already on this workspace, just rename
        i3-msg "rename workspace \"${current_ws_name}\" to \"$(ws_name "$slot" "$name")\"" >/dev/null 2>&1 || true
    else
        # Navigate first (creates the workspace if it doesn't exist), then rename
        i3-msg workspace number "$slot" >/dev/null
        i3-msg "rename workspace \"$slot\" to \"$(ws_name "$slot" "$name")\"" >/dev/null 2>&1 || true
    fi
    active_projects[$slot]="$name"
    save_projects
}

build_entries() {
    # Active projects
    for slot in "${PREFERRED_SLOTS[@]}"; do
        local name="${active_projects[$slot]:-}"
        if [[ -n "$name" ]]; then
            echo "$(ws_name "$slot" "$name")"
        fi
    done

    echo "+ new project"
    echo "~ restore"

    # Rename/close entries only for the current workspace if it's a project
    local current_num
    current_num=$(current_workspace_num)
    local current_project="${active_projects[$current_num]:-}"
    if [[ -n "$current_project" ]]; then
        echo "~ rename: ${current_project}"
        echo "x close: ${current_project}"
    fi
}

cmd_menu() {
    local choice
    choice=$(build_entries | rofi -dmenu -p "project" -i) || exit 0
    handle_choice "$choice"
}

build_entries_modi() {
    # Active projects
    for slot in "${PREFERRED_SLOTS[@]}"; do
        local name="${active_projects[$slot]:-}"
        if [[ -n "$name" ]]; then
            echo "$(ws_name "$slot" "$name")"
        fi
    done

    echo "~ restore"

    # Close entry only for the current workspace if it's a project
    local current_num
    current_num=$(current_workspace_num)
    local current_project="${active_projects[$current_num]:-}"
    if [[ -n "$current_project" ]]; then
        echo "x close: ${current_project}"
    fi
}

cmd_rofi_modi() {
    if [[ $# -eq 0 ]]; then
        build_entries_modi
        exit 0
    fi

    # No actions that need a second prompt — those are only in cmd_menu.
    # Typing a name directly creates a new project.
    handle_choice "$1" >/dev/null 2>&1
}

new_project() {
    local name="$1"

    if name_is_taken "$name"; then
        notify-send "Project name \"$name\" already in use"
        exit 1
    fi

    local current_num
    current_num=$(current_workspace_num)

    # If we're on a free project slot, just label it
    if is_project_slot "$current_num" \
        && [[ -z "${active_projects[$current_num]:-}" ]]; then
        create_project "$name" "$current_num"
    else
        # On a fixed workspace or an already-labeled project slot — auto-pick
        local slot
        slot=$(next_available_slot) || { notify-send "No free project slots"; exit 1; }
        create_project "$name" "$slot"
    fi
}

handle_choice() {
    local choice="$1"

    if [[ "$choice" == "~ restore" ]]; then
        cmd_restore
    elif [[ "$choice" == "+ new project" ]]; then
        local name
        name=$(rofi -dmenu -p "project name") || exit 0
        [[ -z "$name" ]] && exit 0
        new_project "$name"
    elif [[ "$choice" == "~ rename: "* ]]; then
        local old_name="${choice#"~ rename: "}"
        local new_name
        new_name=$(rofi -dmenu -p "rename to") || exit 0
        [[ -z "$new_name" ]] && exit 0
        local current_num
        current_num=$(current_workspace_num)
        if name_is_taken "$new_name" "$current_num"; then
            notify-send "Project name \"$new_name\" already in use"
            exit 1
        fi
        local actual_ws_name
        actual_ws_name=$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused).name')
        i3-msg "rename workspace \"${actual_ws_name}\" to \"$(ws_name "$current_num" "$new_name")\"" >/dev/null 2>&1 || true
        active_projects[$current_num]="$new_name"
        save_projects
    elif [[ "$choice" == "x close: "* ]]; then
        local current_num
        current_num=$(current_workspace_num)
        local actual_ws_name
        actual_ws_name=$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused).name')
        i3-msg "rename workspace \"${actual_ws_name}\" to \"${current_num}\"" >/dev/null 2>&1 || true
        unset "active_projects[$current_num]"
        save_projects
    elif [[ "$choice" =~ ^[0-9]+\ -\  ]]; then
        # Switching to an existing project — choice is "N - name"
        local slot="${choice%%${SEP}*}"
        local project_name="${active_projects[$slot]:-}"
        i3-msg workspace number "$slot" >/dev/null
        # Ensure the workspace has the correct label
        if [[ -n "$project_name" ]]; then
            local actual_ws_name
            actual_ws_name=$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused).name')
            if [[ "$actual_ws_name" != "$(ws_name "$slot" "$project_name")" ]]; then
                i3-msg "rename workspace \"${actual_ws_name}\" to \"$(ws_name "$slot" "$project_name")\"" >/dev/null 2>&1 || true
            fi
        fi
    else
        # Typed a name directly into rofi — treat as new project
        new_project "$choice"
    fi
}

cmd_restore() {
    # Fixed workspace labels
    declare -A fixed_labels=(
        [2]="browser"
        [7]="steam"
        [9]="slack"
        [10]="spotify"
    )
    for slot in "${!fixed_labels[@]}"; do
        local label="${fixed_labels[$slot]}"
        i3-msg "rename workspace \"$slot\" to \"$(ws_name "$slot" "$label")\"" >/dev/null 2>&1 || true
    done

    # Project workspace labels
    for slot in "${!active_projects[@]}"; do
        local name="${active_projects[$slot]}"
        i3-msg "rename workspace \"$slot\" to \"$(ws_name "$slot" "$name")\"" >/dev/null 2>&1 || true
    done

    # Move workspaces to correct outputs
    local laptop="eDP-1"
    local external
    external=$(i3-msg -t get_outputs | jq -r '.[] | select(.active) | .name' | grep -v "^eDP" | head -1)

    if [[ -n "$external" ]]; then
        # Slack on laptop, everything else on external
        i3-msg '[workspace="^9"] move workspace to output '"$laptop" >/dev/null 2>&1 || true
        for ws in $(i3-msg -t get_workspaces | jq -r '.[].name'); do
            local num="${ws%%[^0-9]*}"
            if [[ "$num" != "9" ]]; then
                i3-msg '[workspace="^'"$num"'"] move workspace to output '"$external" >/dev/null 2>&1 || true
            fi
        done
    fi
}

cmd_switch() {
    local slot="$1"
    i3-msg workspace number "$slot" >/dev/null
    local project_name="${active_projects[$slot]:-}"
    if [[ -n "$project_name" ]]; then
        local actual_ws_name
        actual_ws_name=$(i3-msg -t get_workspaces | jq -r '.[] | select(.focused).name')
        if [[ "$actual_ws_name" != "$(ws_name "$slot" "$project_name")" ]]; then
            i3-msg "rename workspace \"${actual_ws_name}\" to \"$(ws_name "$slot" "$project_name")\"" >/dev/null 2>&1 || true
        fi
    fi
}

case "${1:-}" in
    menu) cmd_menu ;;
    switch) cmd_switch "$2" ;;
    rofi-modi) shift; cmd_rofi_modi "$@" ;;
    restore) cmd_restore ;;
    *)
        echo "Usage: i3-project {menu|rofi-modi|restore|switch N}" >&2
        exit 1
        ;;
esac
