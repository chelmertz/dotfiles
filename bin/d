#!/usr/bin/env bash

# "d" for done or diary, a plan-like store
# requires sqlite3, fzf (and pandoc, treemd for some output formats, entr for the watch subcommand)
#
# Usage:
#   d           - interactive fzf interface (default)
#   d html      - export all entries to HTML
#   d watch     - watch for changes to this script and auto-refresh browser

DBFILE="$HOME/Dropbox/d.sqlite3"
D_PREVIEW_DIR="$HOME/Downloads/d-preview"
mkdir -p "$D_PREVIEW_DIR"

export_html() {
	local output_file="$D_PREVIEW_DIR/index.html"
	local tmp_entries="$D_PREVIEW_DIR/entries.json"

	# Get all entries as JSON
	sqlite3 -json "$DBFILE" "
		select id, at, date(at) as day,
		       strftime('%Y', at) as year,
		       strftime('%m', at) as month,
		       strftime('%W', at) as week,
		       body, title
		from log where deleted is null
		order by at desc
	" 2>/dev/null > "$tmp_entries" || echo "[]" > "$tmp_entries"

	# Start HTML
	cat > "$output_file" <<'HTML_HEAD'
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>d - diary export</title>
<script type="module">
  // Initialize mermaid for diagrams
  try {
    const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs');
    mermaid.initialize({ startOnLoad: true, securityLevel: 'loose' });
  } catch (e) {
    console.warn('Mermaid failed:', e);
  }
</script>
<style>
/* Firefox doesn't use fontconfig for file:// URLs due to security policy.
   Explicit @font-face needed. Alternative: about:config -> security.fileuri.strict_origin_policy = false (security risk) */
@font-face {
  font-family: "Go Mono";
  src: url("file:///home/ch/.local/share/fonts/Go/Go-Mono.ttf");
  font-weight: normal;
  font-style: normal;
}
@font-face {
  font-family: "Go Mono";
  src: url("file:///home/ch/.local/share/fonts/Go/Go-Mono-Bold.ttf");
  font-weight: bold;
  font-style: normal;
}
:root {
  --bg: #fff; --fg: #222; --muted: #666; --border: #ccc; --accent: #444;
}
@media (prefers-color-scheme: dark) {
  :root { --bg: #1a1a1a; --fg: #e0e0e0; --muted: #888; --border: #444; --accent: #aaa; }
}
* { box-sizing: border-box; }
body {
  font-family: "Noto Serif", Georgia, "Times New Roman", serif;
  font-size: 1.15rem;
  margin: 0;
  padding: 1rem;
  background: var(--bg);
  color: var(--fg);
  line-height: 1.5;
}
a { color: var(--accent); }
code, pre { font-family: "Go Mono", monospace; }
header {
  width: 100%;
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 20;
  padding: 0.5rem 0;
  margin-top: -0.5rem;
  margin-bottom: 1.5rem;
}
header .header-content {
  display: flex;
  align-items: baseline;
  gap: 1.5rem;
  max-width: 70ch;
  margin: 0 auto;
}
header h1 { margin: 0; flex-shrink: 0; }
header h1 a { color: var(--fg); text-decoration: none; }
header h1 a:hover { text-decoration: underline; }
header nav { font-size: 0.9rem; flex: 1; }
.year-row { margin-bottom: 0.3rem; }
.year-label { font-weight: bold; margin-right: 0.5rem; }
.month-link { margin-right: 0.2rem; text-decoration: none; font-weight: bold; }
.month-link:hover { text-decoration: underline; }
.day-links { font-size: 0.8em; margin-right: 0.5rem; }
.day-links a { color: var(--muted); text-decoration: none; margin-left: 0.15rem; }
.day-links a:hover { text-decoration: underline; color: var(--fg); }
.gap { color: var(--muted); margin: 0 0.3rem; }
article.entry {
  display: block;
  max-width: 70ch;
  margin: 0 auto 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px dotted var(--border);
}
article.entry:last-child { border-bottom: none; }
/* Desktop: date on left, sticky */
@media (min-width: 900px) {
  article.entry {
    display: grid;
    grid-template-columns: 10rem 1fr;
    gap: 1.5rem;
    max-width: calc(70ch + 12rem);
  }
  .entry-sticky {
    /* spans full height of entry, child is sticky inside */
  }
  .entry-date {
    position: sticky;
    top: 4rem;
    text-align: right;
    padding-top: 0.2rem;
  }
  .entry-date time {
    display: block;
    font-size: 0.95rem;
    color: var(--muted);
  }
  .entry-date .month-link {
    display: block;
    font-size: 0.85rem;
    color: var(--muted);
    text-decoration: none;
    font-weight: normal;
  }
  .entry-date .month-link:hover {
    text-decoration: underline;
  }
  .entry-date .rowid {
    display: block;
    font-size: 0.8rem;
    color: var(--muted);
    font-family: "Go Mono", monospace;
    text-decoration: none;
  }
  .entry-date .rowid:hover {
    text-decoration: underline;
  }
  .entry-date .entry-nav {
    display: block;
    font-size: 0.8rem;
    color: var(--muted);
    text-decoration: none;
  }
  .entry-date .entry-nav:hover {
    text-decoration: underline;
    color: var(--fg);
  }
  .entry-main { max-width: 70ch; }
  .entry-title {
    position: sticky;
    top: 4rem;
    background: var(--bg);
    z-index: 5;
  }
  header .header-content { max-width: calc(70ch + 12rem); padding-left: 1rem; padding-right: 1rem; }
}
/* Mobile: date inline */
@media (max-width: 899px) {
  .entry-date {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  .entry-date time { color: var(--muted); }
  .entry-date .month-link { color: var(--muted); text-decoration: none; font-size: 0.85rem; }
  .entry-date .month-link:hover { text-decoration: underline; }
  .rowid { color: var(--muted); font-family: "Go Mono", monospace; font-size: 0.8rem; text-decoration: none; }
  .rowid:hover { text-decoration: underline; }
  .entry-nav { color: var(--muted); font-size: 0.8rem; text-decoration: none; margin-left: 0.5rem; }
  .entry-nav:hover { text-decoration: underline; }
}
.entry-content { }
.entry-title > * {
  margin-top: 0;
  color: var(--bg);
  padding: 0.2em 0.5em;
  display: inline-block;
  position: relative;
}
.entry-title > *::before {
  content: '';
  position: absolute;
  inset: -3px -6px;
  background: var(--muted);
  z-index: -1;
  -webkit-mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' preserveAspectRatio='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2,15 C8,5 18,10 32,7 S52,12 68,6 S88,10 98,16 L97,85 C90,95 78,90 62,93 S42,88 28,94 S12,89 3,83 Z'/%3E%3C/svg%3E");
  mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' preserveAspectRatio='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2,15 C8,5 18,10 32,7 S52,12 68,6 S88,10 98,16 L97,85 C90,95 78,90 62,93 S42,88 28,94 S12,89 3,83 Z'/%3E%3C/svg%3E");
  -webkit-mask-size: 100% 100%;
  mask-size: 100% 100%;
}
.entry-title > * a { color: var(--bg); }
.entry-content blockquote {
  margin: 1rem 0;
  padding: 0.5rem 1rem;
  border-left: 3px solid var(--muted);
  color: var(--muted);
  font-style: italic;
}
.entry-content blockquote > *:first-child { margin-top: 0; }
.entry-content blockquote > *:last-child { margin-bottom: 0; }
.entry-content pre { overflow-x: auto; padding: 0.5rem; }
.entry-content code { font-size: 0.9em; }
.entry-content img { max-width: 100%; }
.entry-content pre.mermaid {
  background: transparent;
  width: min(1500px, calc(100vw - 4rem));
  margin-left: calc(50% - min(750px, 50vw - 2rem));
}
.entry-content pre.mermaid svg {
  width: 100%;
  height: auto;
}
@media (max-width: 1599px) {
  .entry-content pre.mermaid {
    overflow-x: auto;
  }
}
/* Pandoc syntax highlighting (monochrome theme)
   Generated with: pandoc --standalone --highlight-style=monochrome
   then extracted the "code span" rules from the <style> block */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen { div.sourceCode { overflow: auto; } }
code span.al { font-weight: bold; } /* Alert */
code span.an { font-style: italic; } /* Annotation */
code span.cf { font-weight: bold; } /* ControlFlow */
code span.co { font-style: italic; } /* Comment */
code span.cv { font-style: italic; } /* CommentVar */
code span.do { font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.er { font-weight: bold; } /* Error */
code span.in { font-style: italic; } /* Information */
code span.kw { font-weight: bold; } /* Keyword */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.wa { font-style: italic; } /* Warning */
</style>
</head>
<body>
<header>
<div class="header-content">
<h1><a href="#">d</a></h1>
<nav>
HTML_HEAD

	# Generate navigation: group by year/month, show counts and day links
	jq -r '
		group_by(.year + "-" + .month) |
		map({
			year: .[0].year,
			month: (.[0].month | tonumber),
			month_str: .[0].month,
			count: length,
			days: (map(.day) | unique)
		}) |
		group_by(.year) |
		reverse |
		map(
			. as $year_group |
			"<div class=\"year-row\"><span class=\"year-label\">" + .[0].year + ":</span>" +
			([ range(length) | . as $i |
				$year_group[$i] |
				(if $i > 0 and ($year_group[$i-1].month - .month) > 1
				 then "<span class=\"gap\">Â·Â·Â·</span>"
				 else "" end) +
				"<a class=\"month-link\" href=\"#m-" + .year + "-" + .month_str + "\">" +
				(if .month == 1 then "Jan"
				 elif .month == 2 then "Feb"
				 elif .month == 3 then "Mar"
				 elif .month == 4 then "Apr"
				 elif .month == 5 then "May"
				 elif .month == 6 then "Jun"
				 elif .month == 7 then "Jul"
				 elif .month == 8 then "Aug"
				 elif .month == 9 then "Sep"
				 elif .month == 10 then "Oct"
				 elif .month == 11 then "Nov"
				 else "Dec" end) +
				"</a><span class=\"day-links\">" +
				(.days | map(
					(. | split("-") | .[2] | ltrimstr("0") | tonumber) as $d |
					"<a href=\"#d-" + . + "\">" + ($d | tostring) + "</a>"
				) | join(" ")) +
				"</span>"
			] | reverse | join(" ")) +
			"</div>"
		) | join("\n")
	' "$tmp_entries" >> "$output_file"

	echo '</nav></div></header>' >> "$output_file"

	echo '<!-- ENTRIES -->' >> "$output_file"
	echo '</body></html>' >> "$output_file"

	# Create mermaid filter for pandoc - strip YAML frontmatter from
	# mermaid blocks, otherwise the mermaid parser fails and the diagrams
	# are not rendered
	local mermaid_filter_file="$D_PREVIEW_DIR/d-mermaid-filter.lua"
	cat > "$mermaid_filter_file" <<'FILTER'
function CodeBlock(block)
  if block.classes[1] == "mermaid" then
    local text = block.text
    -- Strip YAML frontmatter (everything between --- and ---) from start of block
    text = text:gsub("^%-%-%-.-%-%-%-\n", "")
    return pandoc.RawBlock("html", "<pre class=\"mermaid\">\n" .. text .. "\n</pre>")
  end
end
FILTER

	# Now process each entry with pandoc and insert as direct body children
	local entry_count
	entry_count=$(jq 'length' "$tmp_entries")

	# Build map of day -> first id (first in array = most recent, so first encounter of each day)
	local first_of_day_json
	first_of_day_json=$(jq -c '
		reduce .[] as $e ({};
			if .[$e.day] then . else . + {($e.day): ($e.id | tostring)} end
		)
	' "$tmp_entries")

	# Build map of month -> first id
	local first_of_month_json
	first_of_month_json=$(jq -c '
		reduce .[] as $e ({};
			($e.year + "-" + $e.month) as $ym |
			if .[$ym] then . else . + {($ym): ($e.id | tostring)} end
		)
	' "$tmp_entries")

	for ((i=0; i<entry_count; i++)); do
		local rowid at day year month entry_md entry_html day_anchor month_anchor prev_rowid next_rowid
		rowid=$(jq -r ".[$i].id" "$tmp_entries")
		# prev = newer (earlier in array), next = older (later in array)
		if ((i > 0)); then
			prev_rowid=$(jq -r ".[$((i-1))].id" "$tmp_entries")
		else
			prev_rowid=""
		fi
		if ((i < entry_count - 1)); then
			next_rowid=$(jq -r ".[$((i+1))].id" "$tmp_entries")
		else
			next_rowid=""
		fi
		at=$(jq -r ".[$i].at" "$tmp_entries")
		day=$(jq -r ".[$i].day" "$tmp_entries")
		year=$(jq -r ".[$i].year" "$tmp_entries")
		month=$(jq -r ".[$i].month" "$tmp_entries")
		entry_md=$(jq -r ".[$i].body" "$tmp_entries")
		title_md=$(jq -r ".[$i].title" "$tmp_entries")

		# Convert markdown to HTML with mermaid support
		entry_html=$(echo "$entry_md" | pandoc -f markdown+fenced_code_attributes -t html --highlight-style=kate --lua-filter "$mermaid_filter_file" 2>/dev/null || echo "$entry_md" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
		# Convert title to HTML
		title_html=$(echo "$title_md" | pandoc -f markdown -t html 2>/dev/null || echo "$title_md")

		# Check if this is the first entry of the month (for month anchor)
		month_anchor=""
		if [[ $(echo "$first_of_month_json" | jq -r --arg ym "$year-$month" '.[$ym] // ""') == "$rowid" ]]; then
			month_anchor="<a id=\"m-$year-$month\"></a>"
		fi

		# Check if this is the first entry of the day (for day anchor)
		day_anchor=""
		if [[ $(echo "$first_of_day_json" | jq -r --arg d "$day" '.[$d] // ""') == "$rowid" ]]; then
			day_anchor="<a id=\"d-$day\"></a>"
		fi

		# Format date as "Wednesday, 5th"
		local weekday day_num ordinal formatted_date month_name
		weekday=$(LC_TIME=C date -d "$day" +%A)
		day_num=$(date -d "$day" +%-d)
		month_name=$(LC_TIME=C date -d "$day" +%B)
		case $day_num in
			1|21|31) ordinal="st" ;;
			2|22) ordinal="nd" ;;
			3|23) ordinal="rd" ;;
			*) ordinal="th" ;;
		esac
		formatted_date="$weekday, ${day_num}${ordinal}"

		# Build nav links
		local nav_links=""
		if [[ -n "$prev_rowid" ]]; then
			nav_links="<a class=\"entry-nav\" href=\"#e-$prev_rowid\">â†‘ newer</a>"
		fi
		if [[ -n "$next_rowid" ]]; then
			nav_links="$nav_links<a class=\"entry-nav\" href=\"#e-$next_rowid\">â†“ older</a>"
		fi

		# Create article HTML with id and optional day/month anchors
		local article_html
		article_html=$(cat <<ARTICLE
$month_anchor$day_anchor<article class="entry" id="e-$rowid">
<div class="entry-sticky">
<div class="entry-date"><time datetime="$day">$formatted_date</time><a class="month-link" href="#m-$year-$month">$year $month_name</a><a class="rowid" href="#e-$rowid">#$rowid</a>$nav_links</div>
</div>
<div class="entry-main">
<div class="entry-content">
<div class="entry-title">$title_html</div>
$entry_html
</div>
</div>
</article>
ARTICLE
)
		# Insert before <!-- ENTRIES --> marker
		local tmp_out
		tmp_out=$(mktemp)
		CONTENT="$article_html" awk -v marker="<!-- ENTRIES -->" '
			$0 ~ marker { print ENVIRON["CONTENT"] }
			{ print }
		' "$output_file" > "$tmp_out" && mv "$tmp_out" "$output_file"
	done

	# Clean up marker
	sed -i 's/<!-- ENTRIES -->//g' "$output_file"
	rm -f "$tmp_entries"
}

case "$1" in
	backup)
		if [ -z "$2" ]; then
			echo "usage: d backup <filename>" >&2
			exit 1
		fi
		if ! sqlite3 "$DBFILE" ".backup '$2'"; then
			echo "backup failed" >&2
			exit 1
		fi
		echo "backed up to $2"
		exit 0
		;;
	html)
		export_html
		echo "file://$D_PREVIEW_DIR/index.html"
		exit 0
		;;
	watch)
		# -p postpones, allowing for a debounce-like feature
		echo $0 | entr -p sh -c 'sleep 3; xdg-open $(d html)'
		exit 0
		;;
	perf)
		# Generate flamegraph - requires sudo for perf
		# Use a temp dir for HTML output to avoid creating root-owned files in D_PREVIEW_DIR
		perf_tmp=$(mktemp -d)
		flamegraph_filename="$D_PREVIEW_DIR/d-flame.svg"
		sudo D_PREVIEW_DIR="$perf_tmp" perf record -g -o /tmp/d-perf.data -- bash "$0" html
		sudo perf script -i /tmp/d-perf.data | stackcollapse-perf.pl | flamegraph.pl > "$flamegraph_filename"
		sudo rm -rf /tmp/d-perf.data "$perf_tmp"
		echo "flamegraph: $flamegraph_filename"
		xdg-open "$flamegraph_filename"
		exit 0
		;;
esac

if [ ! -f "$DBFILE" ]; then
	DB_VERSION=0
else
	DB_VERSION=$(sqlite3 "$DBFILE" "select value from meta where key = 'db_version'" 2>/dev/null || echo 0)
fi

while true; do
	case $DB_VERSION in
		0)
			# soft delete because... I forgot about the shortcut and dropped a couple of rows :(
			sqlite3 "$DBFILE" "create table if not exists log(user text, at text default (datetime('now')), entry text, deleted text default null)"
			sqlite3 "$DBFILE" "create table if not exists meta(key text not null unique, value text not null)"
			;;
		1)
			# add id primary key, not null to at and entry, check constraint on entry, generated title column
			sqlite3 "$DBFILE" "
				begin transaction;
				create table log_new(
					id integer primary key autoincrement,
					user text,
					at text not null default (datetime('now')),
					entry text not null check(length(trim(entry)) >= 1),
					deleted text default null,
					title text generated always as (
						trim(
							case
								when instr(trim(entry), char(10)) > 0
								then substr(trim(entry), 1, instr(trim(entry), char(10)) - 1)
								else trim(entry)
							end
						)
					) stored
				);
				insert into log_new(id, user, at, entry, deleted) select rowid, user, at, entry, deleted from log;
				drop table log;
				alter table log_new rename to log;
				commit;
			"
			;;
		2)
			# add body generated column (entry without first line)
			sqlite3 "$DBFILE" "
				begin transaction;
				create table log_new(
					id integer primary key autoincrement,
					user text,
					at text not null default (datetime('now')),
					entry text not null check(length(trim(entry)) >= 1),
					deleted text default null,
					title text generated always as (
						trim(
							case
								when instr(trim(entry), char(10)) > 0
								then substr(trim(entry), 1, instr(trim(entry), char(10)) - 1)
								else trim(entry)
							end
						)
					) stored,
					body text generated always as (
						case
							when instr(trim(entry), char(10)) > 0
							then trim(substr(trim(entry), instr(trim(entry), char(10)) + 1))
							else ''
						end
					) stored
				);
				insert into log_new(id, user, at, entry, deleted) select id, user, at, entry, deleted from log;
				drop table log;
				alter table log_new rename to log;
				commit;
			"
			;;
		*)
			break
			;;
	esac
	if [ $? -ne 0 ]; then
		echo "failed to migrate to step $((DB_VERSION + 1)), exiting" >&2
		exit 1
	fi
	DB_VERSION=$((DB_VERSION + 1))
	sqlite3 "$DBFILE" "insert into meta(key, value) values('db_version', '$DB_VERSION') on conflict(key) do update set value = '$DB_VERSION'"
done

read -r -d '' sql_entries <<EOF
with da as (
	select id, julianday('now')-julianday(at) as days from log
)
select
case when da.days <=3 then 'ðŸ†• ' else '' end as icon,
l.id,
l.at,
l.entry
from log l
inner join da
on da.id = l.id
where l.deleted is null
order by l.at desc;
EOF

read -r -d '' mermaid_header <<'MERMAID_EOF'
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: true });
</script>
MERMAID_EOF

read -r -d '' mermaid_filter <<'FILTER_EOF'
function CodeBlock(block)
  if block.classes[1] == "mermaid" then
    local text = block.text
    -- Remove config section from YAML frontmatter if present, otherwise we will syntax error
    text = text:gsub("(%-%-%-%s*\ntitle:[^\n]*\n)config:%s*\n%s*layout:[^\n]*\n(%-%-%-%s*\n)", "%1%2")
    return pandoc.RawBlock("html", "<pre class=\"mermaid\">\n" .. text .. "\n</pre>")
  end
end
FILTER_EOF

echo "$mermaid_header" > "$D_PREVIEW_DIR/d-mermaid-header.html"
echo "$mermaid_filter" > "$D_PREVIEW_DIR/d-mermaid-filter.lua"

# sqlite's edit() opens the editor configurued in VISUAL
# (i.e. `export VISUAL=vim` in your bashrc/zshrc); if vim, hint that we're
# editing markdown
if [ "$VISUAL" = "vim" ]; then
	VISUAL="vim -c 'set filetype=markdown'"
fi


sqlite3 -json "$DBFILE" "$sql_entries" |
	jq -r '.[] | "\(.id)\t\(.entry | gsub("\n"; " ") | gsub("\t"; " ") | gsub("\r"; " "))\t\(.at)\t\(.icon)"' |
	fzf --ansi \
	--style=full \
	--color=light \
	--delimiter=$'\t' \
	--border \
	--border-label ' done [ tab -> create; enter -> edit; shift-tab -> browser; ctrl-a -> treemd; ctrl-d -> delete entry; esc -> close ]' \
	--padding 1,2 \
	--bind 'focus:transform-preview-label:[[ -n {} ]] && printf " %sfrom %s " {4} {3}' \
	--bind "tab:execute@sqlite3 $DBFILE \"insert into log(user, entry) values ('$USER', trim(trim(edit(''), X'0A')))\"@+become(d)" \
	--bind "ctrl-d:execute@sqlite3 $DBFILE \"update log set deleted=datetime('now') where id={1}\"@+become(d)" \
	--bind "enter:execute@sqlite3 $DBFILE \"update log set entry = trim(trim(edit(entry), X'0A')) where id={1}\"@+become(d)" \
	--bind "shift-tab:execute@$0 html >/dev/null && xdg-open $D_PREVIEW_DIR/index.html@+become(d)" \
	--bind "ctrl-a:execute@treemd <(sqlite3 $DBFILE \"select entry from log where id={1}\")@+become(d)" \
	--with-nth=2 \
	--accept-nth=1 \
	--preview "sqlite3 $DBFILE \"select entry from log where id={1}\" | head -n10 | glow"

# X'0A' is \n, i.e. trim newlines, while trim() removes leading & trailing spaces

