#!/bin/bash

set -euo pipefail

REPO_DIR="${HOME}/code/github/chelmertz/chelmertz.github.io"
TABLES_DIR="${REPO_DIR}/tables"

repo_git() {
    git -C "$REPO_DIR" "$@"
}

if [ ! -d "$TABLES_DIR" ]; then
    zenity --error --text="Tables directory not found: $TABLES_DIR"
    exit 1
fi

# Find all usesthis CSV files
csv_files=("$TABLES_DIR"/usesthis_*.csv)

if [ ${#csv_files[@]} -eq 0 ]; then
    zenity --error --text="No usesthis CSV files found in $TABLES_DIR"
    exit 1
fi

# Create list for zenity selection (show basename without path)
file_list=()
for file in "${csv_files[@]}"; do
    basename=$(basename "$file" .csv)
    basename=${basename#usesthis_}
    file_list+=("$file")
    file_list+=("$basename")
done

# Ask user to select a CSV file
selected_file=$(zenity --list \
    --title="Select CSV File" \
    --column="Path" --column="Category" \
    --hide-column=1 \
    --print-column=1 \
    --width=400 --height=300 \
    "${file_list[@]}") || exit 1

if [ -z "$selected_file" ]; then
    exit 1
fi

# Collect data using zenity forms
result=$(zenity --forms \
    --title="Add Entry" \
    --text="Fill in the details:" \
    --add-entry="Name" \
    --add-entry="Purpose & context" \
    --add-entry="URL" \
    --separator="|" \
    --width=500) || exit 1

if [ -z "$result" ]; then
    exit 1
fi

# Parse the result (separated by |)
IFS='|' read -r name purpose url <<< "$result"

# Escape fields for CSV (handle quotes and commas)
escape_csv() {
    local field="$1"
    # If field contains comma, quote, or newline, wrap in quotes and escape internal quotes
    if [[ "$field" =~ [,\"] ]]; then
        field="${field//\"/\"\"}"
        echo "\"$field\""
    else
        echo "$field"
    fi
}

name=$(escape_csv "$name")
purpose=$(escape_csv "$purpose")
url=$(escape_csv "$url")

# Check for pre-existing changes before modifying anything
pre_existing_changes=$(repo_git status --porcelain 2>/dev/null)

# Append to CSV file
echo "$name,$purpose,$url" >> "$selected_file"

# Auto-commit and push
repo_git fetch origin main --quiet 2>/dev/null || true
ahead_count=$(repo_git rev-list --count origin/main..main 2>/dev/null || echo "0")

if [ -n "$pre_existing_changes" ]; then
    # Repo was dirty, only commit the CSV changes
    repo_git add tables/*.csv
    repo_git commit -m "Update uses-this CSV" --quiet
    notify-send --expire-time=5000 "uses: CSV committed but not pushed (repo had uncommitted changes)"
else
    # Repo was clean, do the full build and commit everything
    make -C "$REPO_DIR" docs --quiet
    repo_git add -A
    repo_git commit -m "Update uses-this CSV" --quiet

    if [ "$ahead_count" -gt 0 ]; then
        notify-send --expire-time=5000 "uses: CSV committed but not pushed (local main was already ahead of origin)"
    else
        if ! repo_git push --quiet 2>&1; then
            notify-send --expire-time=5000 "uses: Failed to push CSV changes"
        fi
    fi
fi

exit 0
